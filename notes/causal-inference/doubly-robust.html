<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Doubly Robust Estimation – Applied Causal Inference</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-d279e387f5997211c97d65d1670dc95e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<meta name="shinylive:serviceworker_dir" content=".">
<script src="site_libs/quarto-contrib/shinylive-0.9.1/shinylive/load-shinylive-sw.js" type="module"></script>
<script src="site_libs/quarto-contrib/shinylive-0.9.1/shinylive/run-python-blocks.js" type="module"></script>
<link href="site_libs/quarto-contrib/shinylive-0.9.1/shinylive/shinylive.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/shinylive-quarto-css/shinylive-quarto.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./regression-adjustment.html">Estimation Tools</a></li><li class="breadcrumb-item"><a href="./doubly-robust.html">Doubly Robust</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Applied Causal Inference</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Framework</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./potential-outcomes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Potential Outcomes &amp; ATE</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./identification-estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Identification vs Estimation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Methods</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./selection-observables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Selection on Observables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./did.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Difference-in-Differences</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./iv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Instrumental Variables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rdd.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regression Discontinuity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./synth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Synthetic Control</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Estimation Tools</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression-adjustment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regression Adjustment</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ipw.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">IPW</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./matching.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Matching</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./entropy-balancing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Entropy Balancing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./doubly-robust.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Doubly Robust</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-idea" id="toc-the-idea" class="nav-link active" data-scroll-target="#the-idea">The idea</a>
  <ul class="collapse">
  <li><a href="#the-aipw-estimator" id="toc-the-aipw-estimator" class="nav-link" data-scroll-target="#the-aipw-estimator">The AIPW estimator</a></li>
  <li><a href="#the-doubly-robust-property" id="toc-the-doubly-robust-property" class="nav-link" data-scroll-target="#the-doubly-robust-property">The “doubly robust” property</a></li>
  <li><a href="#the-dgp" id="toc-the-dgp" class="nav-link" data-scroll-target="#the-dgp">The DGP</a></li>
  <li><a href="#things-to-try" id="toc-things-to-try" class="nav-link" data-scroll-target="#things-to-try">Things to try</a></li>
  </ul></li>
  <li><a href="#why-not-always-use-dr" id="toc-why-not-always-use-dr" class="nav-link" data-scroll-target="#why-not-always-use-dr">Why not always use DR?</a></li>
  <li><a href="#did-you-know" id="toc-did-you-know" class="nav-link" data-scroll-target="#did-you-know">Did you know?</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./regression-adjustment.html">Estimation Tools</a></li><li class="breadcrumb-item"><a href="./doubly-robust.html">Doubly Robust</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Doubly Robust Estimation</h1>
</div>



<div class="quarto-title-meta column-body">

    
  
    
  </div>
  


</header>


<section id="the-idea" class="level2">
<h2 class="anchored" data-anchor-id="the-idea">The idea</h2>
<p>Every estimation tool under <a href="selection-observables.html">selection on observables</a> relies on getting a model right:</p>
<ul>
<li><a href="regression-adjustment.html">Regression adjustment</a> needs the <strong>outcome model</strong> <span class="math inline">\(E[Y \mid X, D]\)</span> to be correct.</li>
<li><a href="ipw.html">IPW</a> needs the <strong>propensity score model</strong> <span class="math inline">\(P(D = 1 \mid X)\)</span> to be correct.</li>
</ul>
<p>What if you’re not sure which one you got right? <strong>Doubly robust (DR) estimation</strong> combines both models and gives you a consistent estimate if <strong>either</strong> one is correctly specified.</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Example: vaccine effectiveness.</strong> You want to know if a vaccine reduces hospitalization. You model <strong>who gets vaccinated</strong> (propensity score: older people and healthcare workers vaccinate more) and you model <strong>hospitalization risk</strong> (outcome model: depends on age, comorbidities, obesity). DR combines both. If your outcome model misses a nonlinear age effect but your propensity score is right — you’re fine. If your propensity score ignores rural vs urban but your outcome model captures it — also fine. You only fail if <em>both</em> models are wrong simultaneously.</p>
</div>
</div>
</div>
<section id="the-aipw-estimator" class="level3">
<h3 class="anchored" data-anchor-id="the-aipw-estimator">The AIPW estimator</h3>
<p>The most common DR estimator is <strong>Augmented Inverse Probability Weighting (AIPW)</strong>:</p>
<p><span class="math display">\[\hat{\tau}_{DR} = \frac{1}{N} \sum_{i=1}^{N} \left[ \hat{\mu}_1(X_i) - \hat{\mu}_0(X_i) + \frac{D_i (Y_i - \hat{\mu}_1(X_i))}{\hat{e}(X_i)} - \frac{(1 - D_i)(Y_i - \hat{\mu}_0(X_i))}{1 - \hat{e}(X_i)} \right]\]</span></p>
<p>where <span class="math inline">\(\hat{\mu}_d(X)\)</span> is the estimated outcome under treatment <span class="math inline">\(d\)</span>, and <span class="math inline">\(\hat{e}(X)\)</span> is the estimated propensity score.</p>
<p><strong>Intuition:</strong> start with the regression prediction (<span class="math inline">\(\hat{\mu}_1 - \hat{\mu}_0\)</span>), then correct it using the IPW-weighted residuals. If the outcome model is perfect, the residuals are zero and the correction vanishes. If the outcome model is wrong but the propensity score is right, the correction fixes the bias.</p>
</section>
<section id="the-doubly-robust-property" class="level3">
<h3 class="anchored" data-anchor-id="the-doubly-robust-property">The “doubly robust” property</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Outcome model</th>
<th>Propensity score</th>
<th>DR consistent?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Correct</td>
<td>Correct</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>Correct</td>
<td>Wrong</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>Wrong</td>
<td>Correct</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>Wrong</td>
<td>Wrong</td>
<td><strong>No</strong></td>
</tr>
</tbody>
</table>
<p>Three out of four — you get two shots at a consistent estimate. This is the key advantage over methods that rely on a single model.</p>
</section>
<section id="the-dgp" class="level3">
<h3 class="anchored" data-anchor-id="the-dgp">The DGP</h3>
<p>To see DR in action, we need a setting where models can be <em>wrong</em>:</p>
<ul>
<li><strong>True outcome:</strong> <span class="math inline">\(Y = 1 + 2X^2 + \tau D + \varepsilon\)</span> (quadratic in <span class="math inline">\(X\)</span>)</li>
<li><strong>True treatment:</strong> <span class="math inline">\(P(D=1 \mid X) = \Phi(1.5 \cdot X)\)</span> (probit)</li>
<li><strong>“Correct” outcome model:</strong> includes <span class="math inline">\(X^2\)</span></li>
<li><strong>“Wrong” outcome model:</strong> linear only (<span class="math inline">\(X\)</span>, no <span class="math inline">\(X^2\)</span>)</li>
<li><strong>“Correct” PS model:</strong> logit on <span class="math inline">\(X\)</span> (close enough to probit)</li>
<li><strong>“Wrong” PS model:</strong> constant 0.5 (ignores <span class="math inline">\(X\)</span> entirely)</li>
</ul>
<pre class="shinylive-r" data-engine="r"><code>#| standalone: true
#| viewerHeight: 680

library(shiny)

ui &lt;- fluidPage(
  tags$head(tags$style(HTML("
    .stats-box {
      background: #f0f4f8; border-radius: 6px; padding: 14px;
      margin-top: 12px; font-size: 14px; line-height: 1.9;
    }
    .stats-box b { color: #2c3e50; }
    .good { color: #27ae60; font-weight: bold; }
    .bad  { color: #e74c3c; font-weight: bold; }
  "))),

  sidebarLayout(
    sidebarPanel(
      width = 3,

      sliderInput("n", "Sample size:",
                  min = 500, max = 3000, value = 1000, step = 250),

      sliderInput("ate", "True ATE:",
                  min = 0, max = 5, value = 2, step = 0.5),

      selectInput("scenario", "Scenario:",
                  choices = c(
                    "Both correct"         = "both",
                    "Only outcome correct"  = "outcome_only",
                    "Only PS correct"       = "ps_only",
                    "Neither correct"       = "neither"
                  )),

      actionButton("go", "New draw", class = "btn-primary", width = "100%"),

      uiOutput("results")
    ),

    mainPanel(
      width = 9,
      fluidRow(
        column(6, plotOutput("fit_plot", height = "430px")),
        column(6, plotOutput("compare_plot", height = "430px"))
      )
    )
  )
)

server &lt;- function(input, output, session) {

  dat &lt;- reactive({
    input$go
    n   &lt;- input$n
    ate &lt;- input$ate
    sc  &lt;- input$scenario

    # Data generating process
    x &lt;- rnorm(n)

    # True PS: probit
    p_true &lt;- pnorm(1.5 * x)
    treat &lt;- rbinom(n, 1, p_true)

    # True outcome: quadratic
    y &lt;- 1 + 2 * x^2 + ate * treat + rnorm(n)

    # --- Outcome models ---
    outcome_correct &lt;- sc %in% c("both", "outcome_only")
    if (outcome_correct) {
      x2 &lt;- x^2
      fit1 &lt;- lm(y ~ treat + x + x2)
      mu1 &lt;- predict(fit1, newdata = data.frame(treat = 1, x = x, x2 = x^2))
      mu0 &lt;- predict(fit1, newdata = data.frame(treat = 0, x = x, x2 = x^2))
    } else {
      fit1 &lt;- lm(y ~ treat + x)
      mu1 &lt;- predict(fit1, newdata = data.frame(treat = 1, x = x))
      mu0 &lt;- predict(fit1, newdata = data.frame(treat = 0, x = x))
    }

    # Regression adjustment estimate
    reg_est &lt;- mean(mu1 - mu0)

    # --- PS models ---
    ps_correct &lt;- sc %in% c("both", "ps_only")
    if (ps_correct) {
      ps &lt;- fitted(glm(treat ~ x, family = binomial))
    } else {
      ps &lt;- rep(0.5, n)
    }

    # IPW estimate
    w &lt;- ifelse(treat == 1, 1 / ps, 1 / (1 - ps))
    ipw_est &lt;- weighted.mean(y[treat == 1], w[treat == 1]) -
               weighted.mean(y[treat == 0], w[treat == 0])

    # Doubly robust (AIPW)
    dr_est &lt;- mean(mu1 - mu0 +
      treat * (y - mu1) / ps -
      (1 - treat) * (y - mu0) / (1 - ps))

    # Naive
    naive &lt;- mean(y[treat == 1]) - mean(y[treat == 0])

    # For plotting: outcome model fit curves
    x_seq &lt;- seq(min(x), max(x), length.out = 200)
    if (outcome_correct) {
      pred_t &lt;- predict(fit1, newdata = data.frame(treat = 1, x = x_seq, x2 = x_seq^2))
      pred_c &lt;- predict(fit1, newdata = data.frame(treat = 0, x = x_seq, x2 = x_seq^2))
    } else {
      pred_t &lt;- predict(fit1, newdata = data.frame(treat = 1, x = x_seq))
      pred_c &lt;- predict(fit1, newdata = data.frame(treat = 0, x = x_seq))
    }
    true_t &lt;- 1 + 2 * x_seq^2 + ate
    true_c &lt;- 1 + 2 * x_seq^2

    list(x = x, y = y, treat = treat,
         x_seq = x_seq, pred_t = pred_t, pred_c = pred_c,
         true_t = true_t, true_c = true_c,
         naive = naive, reg_est = reg_est, ipw_est = ipw_est, dr_est = dr_est,
         ate = ate, sc = sc,
         outcome_correct = outcome_correct, ps_correct = ps_correct)
  })

  output$fit_plot &lt;- renderPlot({
    d &lt;- dat()
    par(mar = c(4.5, 4.5, 3, 1))

    plot(d$x, d$y, pch = 16, cex = 0.3,
         col = ifelse(d$treat == 1, "#3498db30", "#e74c3c30"),
         xlab = "X (confounder)", ylab = "Y (outcome)",
         main = "Outcome Model Fit vs Truth")

    # Fitted curves (solid)
    lines(d$x_seq, d$pred_t, col = "#3498db", lwd = 2.5)
    lines(d$x_seq, d$pred_c, col = "#e74c3c", lwd = 2.5)

    # True curves (dashed)
    lines(d$x_seq, d$true_t, col = "#3498db", lwd = 1.5, lty = 3)
    lines(d$x_seq, d$true_c, col = "#e74c3c", lwd = 1.5, lty = 3)

    outcome_label &lt;- if (d$outcome_correct) "Correct (quadratic)" else "Wrong (linear)"
    ps_label &lt;- if (d$ps_correct) "Correct (logit)" else "Wrong (constant)"

    legend("topleft", bty = "n", cex = 0.75,
           legend = c("Treated data", "Control data",
                      "Model fit (solid)", "True E[Y|X,D] (dotted)",
                      paste0("Outcome: ", outcome_label),
                      paste0("PS: ", ps_label)),
           col = c("#3498db", "#e74c3c", "gray40", "gray40", NA, NA),
           pch = c(16, 16, NA, NA, NA, NA),
           lwd = c(NA, NA, 2.5, 1.5, NA, NA),
           lty = c(NA, NA, 1, 3, NA, NA))
  })

  output$compare_plot &lt;- renderPlot({
    d &lt;- dat()
    par(mar = c(4.5, 9, 3, 2))

    ests &lt;- c(d$dr_est, d$ipw_est, d$reg_est, d$naive)
    labels &lt;- c("Doubly Robust", "IPW", "Regression adj.", "Naive")
    cols &lt;- c("#9b59b6", "#27ae60", "#3498db", "#e74c3c")

    xlim &lt;- range(c(ests, d$ate))
    pad  &lt;- max(diff(xlim) * 0.4, 0.5)
    xlim &lt;- xlim + c(-pad, pad)

    plot(ests, 1:4, pch = 19, cex = 2, col = cols,
         xlim = xlim, ylim = c(0.5, 4.5),
         yaxt = "n", xlab = "Estimated treatment effect",
         ylab = "", main = "Estimator Comparison")
    axis(2, at = 1:4, labels = labels, las = 1, cex.axis = 0.9)

    abline(v = d$ate, lty = 2, col = "#2c3e50", lwd = 2)
    text(d$ate, 4.45, paste0("True ATE = ", d$ate),
         cex = 0.85, font = 2, col = "#2c3e50")

    segments(d$ate, 1:4, ests, 1:4, col = cols, lwd = 2, lty = 2)
  })

  output$results &lt;- renderUI({
    d &lt;- dat()
    b_naive &lt;- d$naive - d$ate
    b_reg   &lt;- d$reg_est - d$ate
    b_ipw   &lt;- d$ipw_est - d$ate
    b_dr    &lt;- d$dr_est - d$ate

    scenario_label &lt;- switch(d$sc,
      both         = "Both models correct",
      outcome_only = "Only outcome model correct",
      ps_only      = "Only propensity score correct",
      neither      = "Neither model correct")

    dr_ok &lt;- abs(b_dr) &lt; abs(b_naive) * 0.5

    tags$div(class = "stats-box",
      HTML(paste0(
        "&lt;b&gt;Scenario:&lt;/b&gt; ", scenario_label, "&lt;br&gt;",
        "&lt;b&gt;True ATE:&lt;/b&gt; ", d$ate, "&lt;br&gt;",
        "&lt;hr style='margin:6px 0'&gt;",
        "&lt;b&gt;Naive:&lt;/b&gt; &lt;span class='bad'&gt;", round(d$naive, 3), "&lt;/span&gt;",
        " (bias: ", round(b_naive, 3), ")&lt;br&gt;",
        "&lt;b&gt;Reg. adj:&lt;/b&gt; ", round(d$reg_est, 3),
        " (bias: ", round(b_reg, 3), ")&lt;br&gt;",
        "&lt;b&gt;IPW:&lt;/b&gt; ", round(d$ipw_est, 3),
        " (bias: ", round(b_ipw, 3), ")&lt;br&gt;",
        "&lt;b&gt;DR:&lt;/b&gt; &lt;span class='", ifelse(dr_ok, "good", "bad"), "'&gt;",
        round(d$dr_est, 3), "&lt;/span&gt;",
        " (bias: ", round(b_dr, 3), ")"
      ))
    )
  })
}

shinyApp(ui, server)</code></pre>
</section>
<section id="things-to-try" class="level3">
<h3 class="anchored" data-anchor-id="things-to-try">Things to try</h3>
<p>Walk through all four scenarios:</p>
<ul>
<li><strong>Both correct:</strong> all three adjusted estimators (regression, IPW, DR) are close to the truth. The left plot shows the fitted curves matching the true curves. DR works.</li>
<li><strong>Only outcome correct:</strong> the PS is constant (ignores X), so IPW is just the naive difference — biased. But regression gets the outcome right, and DR inherits that. DR works.</li>
<li><strong>Only PS correct:</strong> the outcome model fits a line when the truth is quadratic — you can see the misfit on the left plot. Regression is biased. But the PS is right, so the IPW correction rescues DR. DR works.</li>
<li><strong>Neither correct:</strong> both models are wrong. The left plot shows a bad fit, and the PS can’t correct it. DR fails — garbage in, garbage out.</li>
</ul>
<p><strong>Key insight:</strong> DR doesn’t require <em>both</em> models to be right. It requires <em>at least one</em> to be right. That’s the “double robustness” — two chances instead of one.</p>
<hr>
</section>
</section>
<section id="why-not-always-use-dr" class="level2">
<h2 class="anchored" data-anchor-id="why-not-always-use-dr">Why not always use DR?</h2>
<p>If DR is better than regression alone and IPW alone, why not always use it?</p>
<ol type="1">
<li><strong>You still need at least one model right.</strong> DR isn’t magic — it fails when both models are misspecified. In the “neither correct” scenario above, DR is just as biased as the others.</li>
<li><strong>Variance.</strong> DR can have higher variance than a correctly specified single model. The extra robustness comes at the cost of efficiency. In the “both correct” scenario, regression alone is often more precise.</li>
<li><strong>Complexity.</strong> Two models to specify, diagnose, and justify instead of one.</li>
</ol>
<p>In practice, DR is most valuable when you’re <strong>uncertain about your models</strong> — which is most of the time.</p>
<hr>
</section>
<section id="did-you-know" class="level2">
<h2 class="anchored" data-anchor-id="did-you-know">Did you know?</h2>
<ul>
<li><p>The doubly robust property was established by <strong>Scharfstein, Rotnitzky &amp; Robins (1999)</strong> and <strong>Bang &amp; Robins (2005)</strong>. The key insight is that AIPW belongs to a class of <strong>semiparametrically efficient</strong> estimators — it achieves the lowest possible variance among regular estimators when both models are correct, and remains consistent when either is correct.</p></li>
<li><p><strong>Doubly robust DID (DR-DID)</strong> extends the idea to difference-in-differences. <strong>Sant’Anna &amp; Zhao (2020)</strong> showed how to combine outcome regression and propensity score weighting in the DID setting, getting double robustness for treatment effect estimation under parallel trends. This is now standard in the staggered DID literature.</p></li>
<li><p>The DR estimator is connected to <strong>targeted learning</strong> (van der Laan &amp; Rose,</p>
<ol start="2011" type="1">
<li>and <strong>debiased machine learning</strong> (Chernozhukov et al., 2018). These frameworks use machine learning for the nuisance models (<span class="math inline">\(\hat{\mu}\)</span> and <span class="math inline">\(\hat{e}\)</span>) while maintaining valid inference for the causal parameter — DR structure is what makes this possible.</li>
</ol></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>© 2026 <a href="https://nencydhameja.com">Nency Dhameja</a> | <a href="../index.html">All Notes</a><br>Inspired by my advisor, <a href="https://sites.google.com/site/slichterdavid/home">David Slichter</a> · Developed with AI assistance</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>