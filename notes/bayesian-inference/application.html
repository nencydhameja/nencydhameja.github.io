<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Application: Returns to Education – Introduction to Bayesian Thinking</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-d279e387f5997211c97d65d1670dc95e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<meta name="shinylive:serviceworker_dir" content=".">
<script src="site_libs/quarto-contrib/shinylive-0.9.1/shinylive/load-shinylive-sw.js" type="module"></script>
<script src="site_libs/quarto-contrib/shinylive-0.9.1/shinylive/run-python-blocks.js" type="module"></script>
<link href="site_libs/quarto-contrib/shinylive-0.9.1/shinylive/shinylive.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/shinylive-quarto-css/shinylive-quarto.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./application.html">Application</a></li><li class="breadcrumb-item"><a href="./application.html">Returns to Education</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to Bayesian Thinking</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bayes-theorem.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayes’ Theorem</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./priors-posteriors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Priors &amp; Posteriors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bayes-vs-freq.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian vs Frequentist</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bayesian-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Regression</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Computation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mcmc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MCMC</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Hierarchical Modeling</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./shrinkage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Shrinkage</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hierarchical.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hierarchical Models</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Model Checking</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model-comparison.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model Comparison</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./posterior-predictive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Posterior Predictive Checks</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Application</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./application.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Returns to Education</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Bigger Picture</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bayesian-ml.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Thinking in ML &amp; AI</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#putting-it-all-together-returns-to-education" id="toc-putting-it-all-together-returns-to-education" class="nav-link active" data-scroll-target="#putting-it-all-together-returns-to-education">Putting it all together: returns to education</a>
  <ul class="collapse">
  <li><a href="#simulation-full-bayesian-workflow" id="toc-simulation-full-bayesian-workflow" class="nav-link" data-scroll-target="#simulation-full-bayesian-workflow">Simulation: Full Bayesian workflow</a></li>
  <li><a href="#things-to-try" id="toc-things-to-try" class="nav-link" data-scroll-target="#things-to-try">Things to try</a></li>
  </ul></li>
  <li><a href="#the-stata-workflow" id="toc-the-stata-workflow" class="nav-link" data-scroll-target="#the-stata-workflow">The Stata workflow</a></li>
  <li><a href="#what-did-we-learn" id="toc-what-did-we-learn" class="nav-link" data-scroll-target="#what-did-we-learn">What did we learn?</a></li>
  <li><a href="#did-you-know" id="toc-did-you-know" class="nav-link" data-scroll-target="#did-you-know">Did you know?</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./application.html">Application</a></li><li class="breadcrumb-item"><a href="./application.html">Returns to Education</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Application: Returns to Education</h1>
</div>



<div class="quarto-title-meta column-body">

    
  
    
  </div>
  


</header>


<section id="putting-it-all-together-returns-to-education" class="level2">
<h2 class="anchored" data-anchor-id="putting-it-all-together-returns-to-education">Putting it all together: returns to education</h2>
<p>You’ve learned the pieces — <a href="bayes-theorem.html">Bayes’ theorem</a>, <a href="priors-posteriors.html">priors and posteriors</a>, <a href="shrinkage.html">shrinkage</a>, <a href="mcmc.html">MCMC</a>, <a href="bayesian-regression.html">Bayesian regression</a>. Now let’s use them on a real question.</p>
<p><strong>What’s the causal return to an extra year of education on wages?</strong></p>
<p>This is one of the most studied questions in labor economics. The standard approach uses the <strong>Mincer equation</strong>:</p>
<p><span class="math display">\[
\log(\text{wage}) = \beta_0 + \beta_1 \cdot \text{educ} + \beta_2 \cdot \text{exper} + \beta_3 \cdot \text{exper}^2 + \varepsilon
\]</span></p>
<p>We’ll simulate data from this model and walk through the full Bayesian workflow: estimate, interpret, check sensitivity, and compare to OLS.</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>What the literature says:</strong> Estimates of the return to education typically range from 5% to 15% per year (β₁ ≈ 0.05–0.15 in log points). Card (1999) found ~10% using instrumental variables. We’ll use this as our prior information.</p>
</div>
</div>
</div>
<hr>
<section id="simulation-full-bayesian-workflow" class="level3">
<h3 class="anchored" data-anchor-id="simulation-full-bayesian-workflow">Simulation: Full Bayesian workflow</h3>
<p>Walk through all five steps. The left panel shows the posterior for the education coefficient with the prior and OLS estimate. The right panel shows how the posterior shifts as you change the prior strength.</p>
<pre class="shinylive-r" data-engine="r"><code>#| standalone: true
#| viewerHeight: 680

library(shiny)

ui &lt;- fluidPage(
  tags$head(tags$style(HTML("
    .stats-box {
      background: #f0f4f8; border-radius: 6px; padding: 14px;
      margin-top: 12px; font-size: 13px; line-height: 1.8;
    }
    .stats-box b { color: #2c3e50; }
    .good  { color: #27ae60; font-weight: bold; }
    .bad   { color: #e74c3c; font-weight: bold; }
  "))),

  sidebarLayout(
    sidebarPanel(
      width = 3,

      tags$h5("Data"),
      sliderInput("n", "Sample size (n):",
                  min = 30, max = 1000, value = 200, step = 10),

      sliderInput("true_beta", HTML("True &amp;beta;&lt;sub&gt;educ&lt;/sub&gt;:"),
                  min = 0.01, max = 0.20, value = 0.10, step = 0.01),

      tags$hr(),
      tags$h5("Prior"),

      sliderInput("prior_mean", HTML("Prior mean for &amp;beta;&lt;sub&gt;educ&lt;/sub&gt;:"),
                  min = 0, max = 0.20, value = 0.10, step = 0.01),

      sliderInput("prior_sd", HTML("Prior SD for &amp;beta;&lt;sub&gt;educ&lt;/sub&gt;:"),
                  min = 0.005, max = 0.10, value = 0.03, step = 0.005),

      actionButton("go", "New data", class = "btn-primary", width = "100%"),

      uiOutput("results")
    ),

    mainPanel(
      width = 9,
      fluidRow(
        column(6, plotOutput("scatter_plot", height = "300px")),
        column(6, plotOutput("posterior_plot", height = "300px"))
      ),
      fluidRow(
        column(12, plotOutput("sensitivity_plot", height = "280px"))
      )
    )
  )
)

server &lt;- function(input, output, session) {

  dat &lt;- reactive({
    input$go
    n          &lt;- input$n
    true_beta  &lt;- input$true_beta
    prior_mean &lt;- input$prior_mean
    prior_sd   &lt;- input$prior_sd

    # Simulate Mincer equation
    educ  &lt;- round(rnorm(n, 13, 2.5))   # years of education ~13 mean
    educ  &lt;- pmax(educ, 8)               # floor at 8 years
    exper &lt;- round(pmax(rnorm(n, 15, 8), 0))  # years of experience
    sigma &lt;- 0.4                          # residual SD in log wages

    log_wage &lt;- 1.0 + true_beta * educ + 0.03 * exper - 0.0005 * exper^2 +
                rnorm(n, 0, sigma)

    # OLS: regress log_wage on educ, exper, exper^2
    X &lt;- cbind(1, educ, exper, exper^2)
    XtX_inv &lt;- solve(t(X) %*% X)
    beta_ols &lt;- as.numeric(XtX_inv %*% t(X) %*% log_wage)
    resid &lt;- log_wage - X %*% beta_ols
    s2 &lt;- sum(resid^2) / (n - 4)
    se_ols &lt;- sqrt(s2 * diag(XtX_inv))

    # Extract education coefficient (index 2)
    b_ols  &lt;- beta_ols[2]
    se_b   &lt;- se_ols[2]

    # Bayesian posterior (conjugate, focusing on educ coeff)
    prior_prec &lt;- 1 / prior_sd^2
    data_prec  &lt;- 1 / se_b^2
    post_prec  &lt;- prior_prec + data_prec
    post_sd    &lt;- 1 / sqrt(post_prec)
    post_mean  &lt;- (prior_mean * prior_prec + b_ols * data_prec) / post_prec

    w_prior &lt;- prior_prec / post_prec
    w_data  &lt;- data_prec / post_prec

    # CrI
    cri_lo &lt;- qnorm(0.025, post_mean, post_sd)
    cri_hi &lt;- qnorm(0.975, post_mean, post_sd)

    # CI
    ci_lo &lt;- b_ols - 1.96 * se_b
    ci_hi &lt;- b_ols + 1.96 * se_b

    # P(beta &gt; 0 | data)
    p_positive &lt;- 1 - pnorm(0, post_mean, post_sd)

    # P(beta &gt; 0.05 | data)
    p_above_05 &lt;- 1 - pnorm(0.05, post_mean, post_sd)

    # Sensitivity: how posterior mean changes with prior SD
    prior_sd_grid &lt;- seq(0.005, 0.15, length.out = 100)
    sens_means &lt;- numeric(length(prior_sd_grid))
    sens_lo    &lt;- numeric(length(prior_sd_grid))
    sens_hi    &lt;- numeric(length(prior_sd_grid))

    for (i in seq_along(prior_sd_grid)) {
      pp &lt;- 1 / prior_sd_grid[i]^2
      posp &lt;- pp + data_prec
      pm &lt;- (prior_mean * pp + b_ols * data_prec) / posp
      ps &lt;- 1 / sqrt(posp)
      sens_means[i] &lt;- pm
      sens_lo[i] &lt;- qnorm(0.025, pm, ps)
      sens_hi[i] &lt;- qnorm(0.975, pm, ps)
    }

    list(educ = educ, log_wage = log_wage, exper = exper,
         beta_ols_all = beta_ols, se_ols_all = se_ols,
         b_ols = b_ols, se_b = se_b, ci_lo = ci_lo, ci_hi = ci_hi,
         prior_mean = prior_mean, prior_sd = prior_sd,
         post_mean = post_mean, post_sd = post_sd,
         cri_lo = cri_lo, cri_hi = cri_hi,
         w_prior = w_prior, w_data = w_data,
         p_positive = p_positive, p_above_05 = p_above_05,
         true_beta = true_beta, sigma = sigma,
         prior_sd_grid = prior_sd_grid, sens_means = sens_means,
         sens_lo = sens_lo, sens_hi = sens_hi)
  })

  # --- Left: scatterplot with OLS and Bayesian regression lines ---
  output$scatter_plot &lt;- renderPlot({
    d &lt;- dat()
    par(mar = c(4.5, 4.5, 3, 1))

    plot(d$educ, d$log_wage, pch = 16, col = "#2c3e5040", cex = 0.9,
         xlab = "Years of education", ylab = "log(wage)",
         main = "Data + Regression Lines")

    # Predict at education values, holding experience at mean
    educ_seq &lt;- seq(min(d$educ), max(d$educ), length.out = 100)
    mean_exp &lt;- mean(d$exper)

    # OLS fitted line (red)
    ols_pred &lt;- d$beta_ols_all[1] + d$beta_ols_all[2] * educ_seq +
                d$beta_ols_all[3] * mean_exp + d$beta_ols_all[4] * mean_exp^2
    lines(educ_seq, ols_pred, col = "#e74c3c", lwd = 2.5)

    # Bayesian fitted line (blue) — same intercept/exper coeffs, Bayesian educ slope
    bayes_pred &lt;- d$beta_ols_all[1] + d$post_mean * educ_seq +
                  d$beta_ols_all[3] * mean_exp + d$beta_ols_all[4] * mean_exp^2
    lines(educ_seq, bayes_pred, col = "#3498db", lwd = 2.5)

    # True line (green dashed)
    true_pred &lt;- 1.0 + d$true_beta * educ_seq +
                 0.03 * mean_exp - 0.0005 * mean_exp^2
    lines(educ_seq, true_pred, col = "#27ae60", lwd = 2, lty = 2)

    legend("topleft", bty = "n", cex = 0.8,
           legend = c(
             paste0("OLS: ", round(d$b_ols, 4)),
             paste0("Bayesian: ", round(d$post_mean, 4)),
             paste0("True: ", d$true_beta)
           ),
           col = c("#e74c3c", "#3498db", "#27ae60"),
           lwd = c(2.5, 2.5, 2), lty = c(1, 1, 2))
  })

  # --- Right: posterior density with OLS comparison ---
  output$posterior_plot &lt;- renderPlot({
    d &lt;- dat()
    par(mar = c(4.5, 4.5, 3, 1))

    # Range for plotting
    all_means &lt;- c(d$prior_mean, d$b_ols, d$post_mean)
    all_sds   &lt;- c(d$prior_sd, d$se_b, d$post_sd)
    xlim &lt;- range(c(all_means - 3.5 * all_sds, all_means + 3.5 * all_sds))
    x_seq &lt;- seq(xlim[1], xlim[2], length.out = 400)

    prior_y &lt;- dnorm(x_seq, d$prior_mean, d$prior_sd)
    lik_y   &lt;- dnorm(x_seq, d$b_ols, d$se_b)
    post_y  &lt;- dnorm(x_seq, d$post_mean, d$post_sd)

    ylim &lt;- c(0, max(c(prior_y, lik_y, post_y)) * 1.25)

    plot(NULL, xlim = xlim, ylim = ylim,
         xlab = expression(beta[educ]),
         ylab = "Density",
         main = expression("OLS vs Bayesian: " * beta[educ]))

    # Prior (red dashed)
    lines(x_seq, prior_y, col = "#e74c3c", lwd = 2, lty = 2)

    # Likelihood / OLS (gray dotted)
    lines(x_seq, lik_y, col = "gray50", lwd = 2, lty = 3)

    # Posterior (blue filled)
    polygon(c(x_seq, rev(x_seq)), c(post_y, rep(0, length(x_seq))),
            col = "#3498db30", border = NA)
    lines(x_seq, post_y, col = "#3498db", lwd = 2.5)

    # True value
    abline(v = d$true_beta, lty = 2, col = "#27ae60", lwd = 1.5)

    # OLS CI bracket (red)
    y_ci &lt;- max(post_y) * 0.05
    arrows(d$ci_lo, y_ci, d$ci_hi, y_ci,
           code = 3, angle = 90, length = 0.04, lwd = 2, col = "#e74c3c")
    text(d$b_ols, y_ci + max(post_y) * 0.07, "95% CI", cex = 0.7,
         col = "#e74c3c", font = 2)

    # Bayesian CrI bracket (blue)
    y_cri &lt;- max(post_y) * 0.15
    arrows(d$cri_lo, y_cri, d$cri_hi, y_cri,
           code = 3, angle = 90, length = 0.04, lwd = 2, col = "#3498db")
    text(d$post_mean, y_cri + max(post_y) * 0.07, "95% CrI", cex = 0.7,
         col = "#3498db", font = 2)

    legend("topright", bty = "n", cex = 0.75,
           legend = c("Prior", "OLS (likelihood)",
                      "Posterior", expression("True " * beta[educ])),
           col = c("#e74c3c", "gray50", "#3498db", "#27ae60"),
           lwd = c(2, 2, 2.5, 1.5),
           lty = c(2, 3, 1, 2))
  })

  # --- Bottom: sensitivity to prior strength ---
  output$sensitivity_plot &lt;- renderPlot({
    d &lt;- dat()
    par(mar = c(4.5, 4.5, 2.5, 1))

    ylim &lt;- range(c(d$sens_lo, d$sens_hi, d$b_ols, d$true_beta))

    plot(d$prior_sd_grid, d$sens_means, type = "l",
         lwd = 2.5, col = "#3498db",
         xlab = expression("Prior SD for " * beta[educ]),
         ylab = expression("Posterior mean of " * beta[educ]),
         main = "Sensitivity: How Much Does the Prior Matter?",
         ylim = ylim)

    # CrI band
    polygon(c(d$prior_sd_grid, rev(d$prior_sd_grid)),
            c(d$sens_lo, rev(d$sens_hi)),
            col = "#3498db15", border = NA)
    lines(d$prior_sd_grid, d$sens_lo, col = "#3498db50", lty = 2)
    lines(d$prior_sd_grid, d$sens_hi, col = "#3498db50", lty = 2)

    # OLS reference
    abline(h = d$b_ols, col = "#e74c3c", lwd = 1.5, lty = 3)

    # True value
    abline(h = d$true_beta, col = "#27ae60", lwd = 1.5, lty = 2)

    # Prior mean reference
    abline(h = d$prior_mean, col = "#f39c12", lwd = 1.5, lty = 3)

    # Current prior SD
    abline(v = d$prior_sd, col = "#2c3e50", lwd = 1, lty = 3)
    points(d$prior_sd, d$post_mean, pch = 16, col = "#2c3e50", cex = 1.5)

    legend("bottomright", bty = "n", cex = 0.75,
           legend = c("Posterior mean", "95% CrI",
                      "OLS estimate", expression("True " * beta),
                      "Prior mean", "You are here"),
           col = c("#3498db", "#3498db50", "#e74c3c",
                   "#27ae60", "#f39c12", "#2c3e50"),
           lwd = c(2.5, 1.5, 1.5, 1.5, 1.5, NA),
           lty = c(1, 2, 3, 2, 3, NA),
           pch = c(NA, NA, NA, NA, NA, 16))
  })

  output$results &lt;- renderUI({
    d &lt;- dat()

    tags$div(class = "stats-box",
      HTML(paste0(
        "&lt;b&gt;OLS:&lt;/b&gt; ", round(d$b_ols, 4),
        " [", round(d$ci_lo, 4), ", ", round(d$ci_hi, 4), "]&lt;br&gt;",
        "&lt;b&gt;Posterior:&lt;/b&gt; ", round(d$post_mean, 4),
        " [", round(d$cri_lo, 4), ", ", round(d$cri_hi, 4), "]&lt;br&gt;",
        "&lt;b&gt;True:&lt;/b&gt; ", d$true_beta, "&lt;br&gt;",
        "&lt;hr style='margin:8px 0'&gt;",
        "&lt;b&gt;Prior weight:&lt;/b&gt; ", round(d$w_prior * 100, 1), "%&lt;br&gt;",
        "&lt;b&gt;Data weight:&lt;/b&gt; ", round(d$w_data * 100, 1), "%&lt;br&gt;",
        "&lt;hr style='margin:8px 0'&gt;",
        "&lt;b&gt;P(&amp;beta; &gt; 0 | data):&lt;/b&gt; ",
        round(d$p_positive, 4), "&lt;br&gt;",
        "&lt;b&gt;P(&amp;beta; &gt; 0.05 | data):&lt;/b&gt; ",
        round(d$p_above_05, 4)
      ))
    )
  })
}

shinyApp(ui, server)</code></pre>
</section>
<section id="things-to-try" class="level3">
<h3 class="anchored" data-anchor-id="things-to-try">Things to try</h3>
<ul>
<li><strong>Strong correct prior (prior mean = 0.10, prior SD = 0.02, true β = 0.10):</strong> the CrI is tighter than the OLS CI. Incorporating good prior information genuinely improves precision. This is the Bayesian advantage.</li>
<li><strong>Wrong prior + small n (prior mean = 0.02, true β = 0.10, n = 30):</strong> the posterior is pulled toward 0.02 — the prior biases the estimate. Now increase n to 500 — the data overwhelm the wrong prior.</li>
<li><strong>Large n (n = 1000):</strong> the posterior and OLS converge regardless of the prior. The right panel shows the sensitivity curve flattening — the prior SD barely matters.</li>
<li><strong>P(β &gt; 0 | data):</strong> this direct probability statement is impossible with frequentist methods. A 95% CI of [0.03, 0.12] doesn’t tell you the probability that β &gt; 0. The posterior does.</li>
<li><strong>Right panel insight:</strong> as prior SD increases (prior gets vaguer), the posterior mean converges to OLS. The x-axis is “how much you trust the prior” and the curve shows the bias-precision tradeoff.</li>
</ul>
<hr>
</section>
</section>
<section id="the-stata-workflow" class="level2">
<h2 class="anchored" data-anchor-id="the-stata-workflow">The Stata workflow</h2>
<p>Here’s the complete analysis in Stata, mirroring each step above:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>* ----- Step 1: Look <span class="fu">at</span> the <span class="kw">data</span> -----</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">summarize</span> wage education experience</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">scatter</span> wage education</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>* ----- Step 2: OLS -----</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> log_wage = <span class="fu">log</span>(wage)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> exper2 = experience * experience</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">reg</span> log_wage education experience exper2</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>* ----- Step 3: Bayesian with <span class="kw">default</span> (vague) priors -----</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>bayes: <span class="kw">reg</span> log_wage education experience exper2</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>* ----- Step 4: Bayesian with informative prior -----</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>* Literature says ~10% <span class="fu">return</span>, we're fairly confident</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>bayes, prior({log_wage:education}, <span class="fu">normal</span>(0.10, 0.01)) : <span class="co">///</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">reg</span> log_wage education experience exper2</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>* Note: <span class="fu">normal</span>(0.10, 0.01) <span class="kw">means</span> prior <span class="kw">variance</span> 0.01,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>* so prior <span class="kw">SD</span> = 0.1 — centered <span class="fu">at</span> 10% with moderate spread</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>* ----- Step 5: Check convergence -----</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>bayesgraph diagnostics {log_wage:education}</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>* Look <span class="kw">for</span>: stationary <span class="fu">trace</span>, high ESS, R-hat near 1</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>* ----- Step 6: Compare models -----</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>bayesstats <span class="kw">ic</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>* Compare DIC/WAIC to the <span class="kw">default</span>-prior <span class="kw">model</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Interpreting Stata output:</strong> The key columns are <code>Mean</code> (posterior mean), <code>Std. Dev.</code> (posterior SD), and the <code>Equal-tailed</code> credible interval. Compare these directly to the OLS coefficient, standard error, and confidence interval. With vague priors and moderate n, they’ll be nearly identical.</p>
</div>
</div>
</div>
<hr>
</section>
<section id="what-did-we-learn" class="level2">
<h2 class="anchored" data-anchor-id="what-did-we-learn">What did we learn?</h2>
<ol type="1">
<li><p><strong>With a reasonable prior, Bayesian and OLS agree</strong> — especially with large samples. The prior adds almost no bias but can reduce uncertainty.</p></li>
<li><p><strong>The prior adds value when samples are small</strong> or when you have genuine outside information (literature, expert knowledge, previous studies).</p></li>
<li><p><strong>The posterior gives direct probability statements</strong> that OLS can’t: <span class="math inline">\(P(\beta &gt; 0.05 \mid \text{data})\)</span> answers the question “how confident should I be that the return exceeds 5%?” directly.</p></li>
<li><p><strong>Sensitivity analysis is easy and important.</strong> The right panel shows exactly how your conclusions depend on the prior. If the answer doesn’t change much across reasonable priors, your results are robust.</p></li>
</ol>
<p><strong>Where to go deeper:</strong></p>
<ul>
<li><a href="bayes-theorem.html">Bayes’ theorem</a> — the updating formula behind everything</li>
<li><a href="priors-posteriors.html">Priors &amp; Posteriors</a> — mechanics of conjugate updating</li>
<li><a href="shrinkage.html">Shrinkage</a> — why the prior pulls estimates and when it helps</li>
<li><a href="bayesian-regression.html">Bayesian Regression</a> — the full OLS vs Bayesian comparison</li>
<li><a href="model-comparison.html">Model Comparison</a> — Bayes factors for choosing between models</li>
<li><a href="posterior-predictive.html">Posterior Predictive Checks</a> — does the model fit?</li>
</ul>
<hr>
</section>
<section id="did-you-know" class="level2">
<h2 class="anchored" data-anchor-id="did-you-know">Did you know?</h2>
<ul>
<li><p><strong>Mincer (1974)</strong> introduced the log-linear earnings equation in <em>Schooling, Experience, and Earnings</em>. The specification — log wages regressed on education and a quadratic in experience — became the workhorse of labor economics. Nearly every study of returns to education starts from this framework.</p></li>
<li><p><strong>Card (1999, 2001)</strong> used instrumental variables (geographic proximity to colleges) to address the endogeneity of education, finding returns of about 10% per year. His work highlighted that OLS may underestimate the return for marginal students — those on the fence about attending college.</p></li>
<li><p><strong>Bayesian approaches in development economics:</strong> researchers studying returns to education in developing countries often face small samples and noisy data. Informative priors based on findings from similar countries can stabilize estimates — a natural application of the framework you just practiced.</p></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p><span style="white-space:nowrap">© 2026 <a href="https://nencydhameja.com">Nency Dhameja</a> | <a href="../index.html">All Notes</a> | Developed with AI assistance | <a href="mailto:nencydhameja@gmail.com">Feedback?</a></span></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>